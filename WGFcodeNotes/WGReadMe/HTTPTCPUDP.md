## 网络协议

### 一.HTTP协议
### 首先我们需要先明白什么是URL?
#### URL全称是Uniform Resource Locator:统一资源定位符,简单来说URL就是资源的地址、位置,互联网中的每一个资源都有一个唯一的URL,URL的格式: 协议://主机地址/路径
        协议:不同的协议代表者不同的资源查找方式,资源传输方式
        主机地址:存放资源的主机(服务器)的IP地址或者域名
        路径:资源在主机（服务器）中的具体位置
#### URL常见的协议如下: 需要注意的是URL不允许写中文,如果URL中存在中文,需要进行转码处理
    file://       访问本地计算机上的资源
    mailto://     访问电子邮件地址
    ftp://        访问共享主机的文件资源
    http://       访问远程的网络资源

#### 1.HTTP通信过程
#### 1.1HTTP协议规定:一个完整的HTTP请求(客户端向服务器发起请求)包含下列内容
    请求头:
        GET /minion.png HTTP/1.1        //包含了请求方法、请求资源路径、HTTP协议版本
        Host: 120.25.226.186:32812      //客户端想访问的服务器主机地址
        User-Agent: Mozilla/5.0         //客户端的类型，客户端的软件环境
        Accept: text/html, /            //客户端所能接收的数据类型
        Accept-Language: zh-cn          //客户端的语言环境
        Accept-Encoding: gzip           //客户端支持的数据压缩格式
    请求体: 客户端发给服务器的具体数据，比如文件数据(POST请求才会有)
#### 1.2HTTP协议规定:一个完成的HTTP响应(服务器向客户端返回数据)包含下列内容
    响应头：
        包含了对服务器的描述、对返回数据的描述
        HTTP/1.1 200 OK                     //包含了HTTP协议版本、状态码、状态英文名称
        Server: Apache-Coyote/1.1           //服务器的类型
        Content-Type: image/jpeg            //返回数据的类型
        Content-Length: 56811               //返回数据的长度
        Date: Mon, 23 Jun 2014 12:54:52 GMT //响应的时间
    响应体：服务器返回给客户端的具体数据，比如文件数据

### 二.UDP协议
#### UDP:用户数据报协议,UDP协议的特点:
1. UDP协议是一种无连接的、不可靠的传输层协议

        UDP协议在传输报文前不需要在通信双方建立连接,因此减少了协议开销与传输延迟
        UDP协议对报文除了提供一种可选的校验外,几乎没有提供其它的保证数据传输可靠性的措施
        如果UDP协议检测出收到的分组出错,它就会丢弃这个分组,既不确认也不通知发送端进行重传
        因此可以说UDP协议提供的是“尽力而为”的传输服务
        
2. UDP协议是一种面向报文的传输层协议

        UDP协议对应用程序提交的报文,在添加了UDP头部后构成了TPDU(传输协议数据单元),然后就直接向下提交给IP层了
        UDP对应用程序提交的报文既不合并和不拆分,而是保留原报文的长度和格式
        接收端会将发送端提交的报文原封不动的提交给接收端应用程序
        因此在使用UDP协议时,应用程序必须选择合适长度的报文,如果报文太短,则协议开销较大
        如果太长,UDP协议向IP提交的TPDU可能在IP层被分片,这样会降低协议的效率
#### UDP协议报文的格式
    UDP报文 = UDP报头(固定的8个字节) + 数据(应用程序报文)
    UDP报头主要包含以下字典
    1.端口号: 包含源端口号(16位-2个字节)和目的端口号(16位-2个字节)
    2.长度: (16位-2字节)定义了包括报头在内的用户数据报的总长度,用户数据报的长度最大为65535字节(2^16-1)(大约63.999KB),最小为8字节,但UDP报头的长度固定为8字节,因此实际UDP报文的数据长度最大为65535-8=65527个字节
    3.校验和:UDP校验和是可选的,UDP校验和用来检验整个用户数据、UDP报头与伪报头在传输中是否出现差错
   

#### UDP协议适用范围
1. 视频播放应用
    视频播放应用对数据交付实时性要求较高,而对数据交付可靠性要求较低
    如果采用TCP,可能因为重传个别丢失的报文而加大传输延迟,反而对视频造成播放不利的影响
2. 简单的交互式应用
有些应用可能只需要进行简单的请求和应答即可,可以选择UDP
可以通过设置“定时器/重传机制”来处理由于IP数据分组丢失的问题,而不需要选择有确认/重传的TCP协议
3. 多播和广播应用
UDP支持一对一、一对多、多对多的交互式通信,这点TCP协议是不支持的
UDP协议头部长度只有8个字节,TCP协议头部长度是20个字节
UDP协议没有拥塞控制,网络拥塞时不会要求源主机降低报文发送速率,而只会丢弃个别的报文
这对于IP电话、实时视频会议应用都是适用的,因为这类应用要求源主机以恒定速率发送报文,要拥塞发生
时,允许丢弃部分报文

#### UDP 优缺点
优点: 简洁、快速、高效
缺点:没有提供差错控制机制;在网络拥塞严重时缺乏必要的控制和调节机制

### 三.TCP协议
### TCP:传输控制协议,TCP协议主要特点
1. TCP协议支持面向连接的传输服务

        TCP在传输数据前,必须在源进程端口和目标进程端口之间建立一条TCP传输连接,每个TCP传输连接用双方端口号来标识,
        因为TCP是建立在不可靠的网络层IP协议之上,IP协议不能提供任何可靠性保障
        机制,所以传输的可靠性只能TCP自己来解决了
2. TCP协议支持字节流的传输

        字节流相当于一个管道,从一端放入什么内容,从另一端可以照原样取出什么内容,它描述的
        是一个不出现流失、重复和乱序的数据传输过程.
        如果是键盘输入数据,那么应用程序将逐个字符的提交给发送端,如果是文件,那么数据可能是逐行或逐块交付给发送端,
        应用程序和TCP每次交互的数据长度可能都不相同.
        TCP协议将应用程序提交的数据看成是一连串的、无结构的字节流,为了支持字节流传输,发送端和接收端都需要使用缓存
        发送端使用发送缓存来存储应用程序送来的数据,发送端不可能为发送的每个写操作创建一个报文段,而是选择
        将几个写操作组合成一个报文段,然后提交给IP协议,由IP协议封装成IP分组,然后传输给接收端.
        接收端IP协议将接收的IP分组拆封后,将数据段提交给接收端的TCP协议,接收端TCP协议
        将接收的字节存储在接收缓存中,应用程序使用读操作将接收数据从接收缓存中读出.
        TCP协议将数据看成是一连串的、无结构的字节流,因此接收端应用程序的数据字节的起始
        和终结位置必须由应用程序自己确定.
        
3. 支持全双工通信

        TCP协议允许通信双方的应用程序在任何时候都可以发送数据,由于双方都设置有发送和
        接收缓冲区,应用程序将要发送的数据字节提交给发送缓冲区,数据字节的实际发送过程
        由TCP控制,而接收端在正确接收到数据字节后,将它缓存在接收缓冲区,高层应用从缓冲区读取数据

4. 支持同时建立多个并发的TCP连接

        TCP协议支持同时建立多个连接,如在服务器端,一个服务器必须可以同时处理多个客户的访问
        .TCP协议支持一个服务器与多个客户端同时建立多个TCP连接,也支持一个
        客户端与多个服务器同时建立多个TCP连接,TCP协议软件将分别管理多个TCP连接
5. 支持可靠的传输服务

        TCP使用确认机制检查数据是否安全和完整的到达,并且提供了拥塞控制功能,
        TCP支持可靠数据传输的关键是对发送和接收的数据进行跟踪、确认和重传.
        注意:TCP协议建立在不可靠的网络层IP协议之上,一旦IP协议及以下层出现传输错误,TCP协议只能不断的
        进行重传,视图弥补传输中出现的问题.
        传输层传输的可靠性是建立在网络层基础上的,同时也就会收到它们的限制
#### 总结:TCP特点:面向连接、面向字节流、支持全双工、支持并发连接、提供确认/重传与拥塞控制功能

### TCP协议报文格式
#### TCP报文也称为报文段,主要组成如下:
       TCP报文 = TCP头部(TCP报头) + 数据
       TCP头部(TCP报头)长度为20~60个字节,其中固定长度20个字节,可选项占用的字节可变,最多为40个字节
### TCP报头组成如下:
1. 端口号: 源端口号(16位-2个字节) + 目标端口号(16位-2个字节)
2. 序号: 长度为32位(4个字节),范围为0~2^32-1.
##### TCP是面向字节流的,它要为发送字节流中的每个字节按照顺序编号;在TCP建立连接时,双方都需要产生一个随机的初始序号(ISN);因为初始需要时随机产生的,所以一个TCP连接的通信双方的序号是不同的;
##### 例如:需要发送420个字节的文件,初始序号(ISN)位1010,分5个报文段发送,前4个报文段长度都是100个字节,第5个报文段长度为20个字节,那么第一个报文段的序号即1010~1110,依次为(1111~1211),(1212~1312),(1313~1413),(1414~1434)
3. 确认号: 长度32为(4个字节)
##### 确认号表示一个进程已经正确接收序号为N的字节,要求发送端下一个应该发送序号为N+1的字节的报文段
#### 例如: 主机A向主机B发送了序号为200~500的报文段,主机B正确接收到后,主机B在下一个发送到主机A的报头的确认号写成“501(500+1)”,主机A在接收到该报文后,读到确认号为“501”时,就认为主机B已经正确接收到最后一个字节的序号为500及以前所有的字节,希望接下来发送以序号为501开始的报文段,这就是网络协议中典型的 **捎带确认方法**
4. 报头长度: 报头长度字段的长度为4位,TCP报头长度是以4字节为一个单元来计算的,实际报头长度在20~60个字节,因此这个字段的值在5(4*5)~15(4*15)之间
5. 保留: 保留字段长度为6位
6. 控制: 控制字段定义了6种不同的控制位或标志,占6位
7. 窗口:窗口字典长度为16位
##### 因为接收端的接收缓冲区是受到限制的,因为需要设置一个窗口字段来表示下一次传输接收端还有多大的接收容量,通知发送端下一次最多可以发送报文段的字节数;发送端根据接收端通知的窗口值来调整自己的发送窗口值的大小;窗口字段值是动态变化的
8. 紧急指针: 长度为16位(2个字节)
##### 当控制位中的紧急位为1时,表示该报文段的优先级高,TCP协议软件要在优先处理完紧急数据后才能恢复正常的操作
9. 选项: 即可选项,最多有40个字节
10. 校验和: 长度为16位(2个字节)
##### 和UDP协议中的校验和的计算校验过程相同,UDP校验和是可选的,而TCP是必须有的

### TCP最大段长度
#### TCP对报文数据部分最大长度有一个规定,这个值称为**最大段长度(MMS)**,表示在构成一个TCP报文段时,最多可以在报文的数据字段中放置的数据字节数量,这个值与窗口大小无关;MSS是TCP报文中数据部分的最大字节数限定值,不包括报头长度;
#### MSS值的选择需要考虑几方面的因素
1. 协议开销: TCP报文的长度=TCP报头+数据部分,TCP报头长度是20~60个字节,如果报头值取一个折中的值40个字节为例,如果MSS值也选择40个字节,那么每个报文段的50%用来传输数据,显示,MSS值太小会增加协议开销
2. IP分片: TCP报文是要通过IP分组传输的,如果MSS值选择太大,受到IP分组长度的限制,较长的报文段在IP层将会被分片传输,分片的结果同样会增加网络层的开销和传输出错的概率
3. 发送和接收缓冲区的限制: 为保证TCP面向字节流传输,建立TCP连接的发送端和接收端都必须设置发送和接收缓冲区,MSS值的大小直接影响到发送和接收缓冲区设置的大小和使用效率
4. MSS的默认值: 确定的默认MSS值为536个字节,考虑到报头固定长度20个字节,那么默认的报文段长度就是556字节,对于某些应用,MSS值也许不一定适合,开发人员需要选择其它MSS值,这个要求可以在建立TCP连接时使用SYN(控制中的同步位)报文中最大长度选项来协商,TCP允许连接的双方可以选择不同的MSS值

### TCP连接建立和释放
#### TCP连接建立(三次握手)
1. 客户端处于“关闭”状态,当准备发起一次TCP连接时处于“准备发送”状态,首先向处于“收听”状态的服务器端TCP进程发送第一个控制位“SYN=1”的“连接建立请求报文”,该报文不携带任何数据字段,但需要给报文一个随机产生的序号"seq=x",但是不能为0.即“SYN=1,seq=x”
#### 为什么随机产生的序号不能为0?
#### 避免因TCP连接非正常断开而可能引起的混乱,如果连接突然中断,可能有一个或两个进程同时等待对方的确认应答,而这个时候有一个新连接的序号也是从0开始,那么接收进程就有可能认为是对方重传的报文,这样就有可能造成连接过程的错误,所以TCP协议规定SYN报文序号必须随机产生,并且不能为0

2. 服务端接收到“连接建立请求报文”后,如果同意建立连接,则向客户端发送第二个控制位“SYN=1,ACK=1”的“连接建立请求确认报文”,确认号是"ack=x+1",表示是对第一个“连接建立请求报文”(序号"seq=x")的确认,同样的确认报文不携带任何数据字段,但是需要给报文一个随机产生的序号"seq=y",此时服务器处于“准备接收”状态,即“SYN=1,ACK=1,seq=y,ack=x+1”
3. 客户端接收到服务端的“连接建立请求确认报文”后,向服务端发送第三个控制位ACK=1“连接建立请求确认报文”,由于该报文是对服务带发送过来的“连接建立请求确认报文”(序号seq=y)的确认,因此确认序号为“ack=y+1”,同样该报文不携带任何数据字段,但是需要给报文一个序号,按照TCP协议规定,这个序号仍然为"seq=x+1",即“ACK=1,seq=x+1,ack=y+1”,此时客户端进入“已建立连接”状态,当服务端在接收到ACK报文之后也进入“已建立连接”状态
#### TCP报文传输
当客户端和服务端都进入“已建立连接”状态后,双方的TCP连接建立,进入HTTP交互状态,双方的应用程序就可以使用这个连接,进行全双工的字节流传输
#### 为了保证TCP工作正常、有序的进行,TCP设置了“保持计时器”来防止TCP连接处于长时期空闲,“保持计时器”一般是服务端来设置,当服务端收到客户端的报文后,就将“保持计时器”复位,如果服务端过了设定的时间没有收到客户端的信息,它就会发送“探测报文”,如果发送10个“探测报文”(每一个间隔75秒)还没有响应,就会认为客户端出现故障,进而终止该连接

#### TCP释放(四次挥手)
#### TCP释放过程较复杂,客户端和服务端都可以主动提出连接释放请求,以客户端主动提出释放请求来说明“四次握手”的过程
1. 当客户端主动提出释放TCP连接时,客户端进入“释放等待”状态,向服务端发送第一个控制位FIN=1的“连接释放请求报文”,提出连接释放请求,停止发送数据.“连接释放请求报文”不携带任何数据字段,但需要给报文一个序号“seq=m”,m等于客户端向服务端发送的最后一个字节的序号+1,即“FIN=1,seq=m”,此时客户端处于“FIN-WAIT-1”状态,此时客户端仍然可以接收服务端发送过来的数据,但是客户端不能再向服务端发送数据了
2. 服务端接收到“连接释放请求报文”后,需要向客户端发送“连接释放请求确认报文”,表示对接收到第一个连接释放请求报文的确认,因此“ack=m+1”,同样该报文不携带任何数据字段,但是需要一个序号"seq=n",n等于服务器发送的最后一个字节序号+1,即“ACK=1,seq=n,ack=m+1”

#### TCP服务器进程向高层应用进程通知客户端请求释放TCP连接,客户端到服务器端的TCP连接断开,但是服务器端到客户端的TCP连接还没有断开,如果服务器还有数据报文需要发送时,还可以继续向客户端发送直至发送完毕,这种状态称为“半关闭”状态,“半关闭”状态需要持续一段时间,客户端在接收到ACK报文后进入“FIN-WAIT-2”状态,服务器端进入“CLOSE-WAIT”状态

3. 服务端高层应用程序如果没有数据需要发送时,会通知TCP可以释放连接,这时服务端向客户端发送“连接释放请求报文”,同样不携带任何数据字段,但需要给该报文提供序号,此时的序号取决于“半关闭”状态时,服务端是否发送过数据报文,因此序号假设为w,即“FIN=1,ACK=1,seq=w,ack=m+1”,此时服务端经过“LAST-ACK”状态后转回“LISTEN”监听状态

4. 客户端在接收到服务端发送的FIN报文后,向服务端发送“连接释放请求报文”,表示对服务端“连接释放请求确认报文”的确认,即“ACK=1,seq=m+1,ack=w+1”

#### TCP释放过程中的时间等待计时器
#### 为了保证TCP来呢即释放过程正常进行,TCP设置了“时间等待计时器”,当TCP关闭一个连接时,它并不认为这个连接马上就真正的关闭,这时,客户端进入“TIME-WAIT”状态,需要再等待两个”最长报文寿命(MSL)“时间后,菜真正进入“CLOSE关闭”状态

#### 客户端和服务端经过“四次握手”后,确认双方已经同意释放连接,客户端仍需要采取延迟2MSL时间,为了确保服务端在最后阶段发送给客户端的数据,以及客户端发送给服务端最后一个ACK报文都正确的被接收,防止因个别报文传输错误导致连接释放失败
